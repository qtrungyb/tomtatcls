<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tóm tắt CLS</title>
<style>
    :root {
        --primary-color: #2980b9;
        --primary-light: #e6f2fb;
        --primary-dark: #1c5d94;
        --secondary-color: #27ae60;
        --secondary-dark: #1f8f4c;
        --accent-color: #e67e22;
        --accent-dark: #d35400;
        --danger-color: #e74c3c;
        --danger-dark: #c0392b;
        --text-color: #2c3e50;
        --text-light: #34495e;
        --bg-color: #f0f4f8;
        --card-bg: #ffffff;
        --border-radius: 16px;
        --box-shadow: 0 8px 30px rgba(44, 62, 80, 0.12);
        --transition: all 0.25s cubic-bezier(0.645, 0.045, 0.355, 1);
    }

    .dark-mode {
        --primary-color: #3498db;
        --primary-light: #1d3557;
        --primary-dark: #2c3e50;
        --secondary-color: #2ecc71;
        --secondary-dark: #27ae60;
        --accent-color: #f39c12;
        --accent-dark: #e67e22;
        --text-color: #ecf0f1;
        --text-light: #bdc3c7;
        --bg-color: #121212;
        --card-bg: #1e1e1e;
        --box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--bg-color);
        color: var(--text-color);
        line-height: 1.6;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
    }

    #container {
        display: flex;
        width: min(1100px, 95%);
        max-width: 100%;
        min-height: 80vh;
        background: var(--card-bg);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        overflow: hidden;
        transition: var(--transition);
        position: relative;
    }

    #inputArea, #tableArea {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 2.5rem;
        overflow: hidden;
    }

    #inputArea {
        background: var(--primary-light);
        border-right: 1px solid rgba(41, 128, 185, 0.2);
    }

    h2 {
        font-weight: 700;
        font-size: 1.75rem;
        color: var(--primary-color);
        margin-bottom: 2rem;
        text-align: center;
        position: relative;
        padding-bottom: 0.5rem;
    }

    h2::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 3px;
        background: linear-gradient(90deg, var(--primary-color), rgba(41, 128, 185, 0.3));
        border-radius: 3px;
    }

    textarea#inputData {
        flex-grow: 1;
        padding: 1.5rem;
        font-family: 'Courier New', monospace;
        font-size: 0.95rem;
        background: var(--card-bg);
        border: 1px solid rgba(41, 128, 185, 0.3);
        border-radius: 12px;
        resize: none;
        color: var(--text-color);
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        transition: var(--transition);
        line-height: 1.7;
    }

    textarea#inputData:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(41, 128, 185, 0.2);
        outline: none;
    }

    button {
        border: none;
        border-radius: 50px;
        cursor: pointer;
        font-weight: 600;
        letter-spacing: 0.03em;
        transition: var(--transition);
        text-transform: uppercase;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 1.5rem;
    }

    button#processBtn {
        background-color: var(--primary-color);
        color: white;
        padding: 1rem;
        box-shadow: 0 4px 15px rgba(41, 128, 185, 0.3);
        flex: 1;
    }

    button#processBtn:hover {
        background-color: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(41, 128, 185, 0.4);
    }

    button#clearBtn {
        background-color: var(--danger-color);
        color: white;
        padding: 1rem;
        box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        flex: 1;
    }

    button#clearBtn:hover {
        background-color: var(--danger-dark);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
    }

    #summaryContainer {
        margin-top: 2rem;
        display: none;
        flex-direction: column;
        gap: 1rem;
        align-items: center;
    }

    #summary {
        font-weight: 500;
        font-size: 1rem;
        color: var(--text-light);
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 1rem;
        width: 100%;
        text-align: center;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        border: 1px solid rgba(0,0,0,0.05);
    }

    .export-group {
        display: flex;
        gap: 10px;
        margin-top: 1.5rem;
        width: 100%;
    }

    button#copySummaryBtn {
        background: var(--secondary-color);
        color: white;
        padding: 0.8rem;
        box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        flex: 1;
    }

    button#copySummaryBtn:hover {
        background: var(--secondary-dark);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
    }

    button#exportExcelBtn {
        background: #16a085;
        color: white;
        padding: 0.8rem;
        box-shadow: 0 4px 15px rgba(22, 160, 133, 0.3);
        flex: 1;
    }

    button#exportExcelBtn:hover {
        background: #138d75;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(22, 160, 133, 0.4);
    }

    #tableArea {
        background: var(--card-bg);
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .table-container {
        flex: 1;
        overflow-y: auto;
        border: 1px solid rgba(0,0,0,0.05);
        border-radius: 10px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    }

    table#dataTable {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 0.5rem;
        font-size: 0.9rem;
    }

    table#dataTable th {
        background-color: var(--primary-color);
        color: white;
        padding: 1rem;
        font-weight: 700;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    table#dataTable td {
        padding: 0.8rem 1rem;
        background: rgba(230, 242, 251, 0.2);
        border: none;
        color: var(--text-color);
    }

    table#dataTable tr:hover td {
        background: rgba(203, 230, 255, 0.3);
    }

    #themeToggle {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--primary-color);
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 20;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }

    #themeToggle:hover {
        transform: scale(1.1);
    }

    .toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background-color: #27ae60;
        color: white;
        padding: 12px 24px;
        border-radius: 50px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 1000;
        opacity: 0;
        transition: all 0.3s ease;
    }

    .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }

    ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }

    ::-webkit-scrollbar-thumb {
        background: rgba(41, 128, 185, 0.5);
        border-radius: 3px;
    }

    @media (max-width: 768px) {
        #container {
            flex-direction: column;
            min-height: auto;
        }
      
        #inputArea, #tableArea {
            padding: 1.5rem;
        }
      
        #inputArea {
            border-right: none;
            border-bottom: 1px solid rgba(41, 128, 185, 0.2);
        }
      
        textarea#inputData {
            min-height: 200px;
        }
      
        h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .button-group, .export-group {
            flex-direction: column;
        }

        #themeToggle {
            top: 15px;
            right: 15px;
            width: 35px;
            height: 35px;
        }
    }
</style>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
<div id="container" role="main" aria-label="Ứng dụng tóm tắt CLS">
    <!-- Nút chuyển đổi chế độ sáng/tối -->
    <button id="themeToggle" aria-label="Chuyển đổi chế độ sáng tối">
        <i class="fas fa-moon"></i>
    </button>
    
    <section id="inputArea" aria-labelledby="inputTitle">
        <h2 id="inputTitle">Nhập chỉ số</h2>
        <textarea id="inputData" aria-describedby="inputDesc" placeholder="Dán dữ liệu chỉ số vào đây..."></textarea>
        
        <div class="button-group">
            <button id="processBtn" onclick="processData()" aria-label="Xử lý dữ liệu">
                <i class="fas fa-cogs"></i> Tóm tắt cận lâm sàng
            </button>
            <button id="clearBtn" onclick="clearData()" aria-label="Xóa dữ liệu">
                <i class="fas fa-trash"></i> Xóa
            </button>
        </div>
        
        <div id="summaryContainer" role="region" aria-live="polite">
            <p id="summary"></p>
            <div class="export-group">
                <button id="copySummaryBtn" onclick="copySummary()" aria-label="Sao chép tóm tắt dữ liệu">
                    <i class="fas fa-copy"></i> Sao chép
                </button>
                <button id="exportExcelBtn" onclick="exportToExcel()" aria-label="Xuất Excel">
                    <i class="fas fa-file-excel"></i> Xuất Excel
                </button>
            </div>
        </div>
    </section>

    <section id="tableArea" aria-labelledby="tableTitle"> 
        <h2 id="tableTitle">Bảng chỉ số</h2>
        <div class="table-container">
            <table id="dataTable" aria-describedby="tableDesc" role="table">
                <thead role="rowgroup">
                    <tr role="row">
                        <th role="columnheader" scope="col">STT</th>
                        <th role="columnheader" scope="col">Mã</th>
                        <th role="columnheader" scope="col">Tên chỉ số</th>
                        <th role="columnheader" scope="col">Đơn vị đo</th>
                        <th role="columnheader" scope="col">Trung bình</th>
                        <th role="columnheader" scope="col">Giá trị</th>
                    </tr>
                </thead>
                <tbody role="rowgroup">

                </tbody>
            </table>
        </div>
    </section>
</div>

<div id="toast" class="toast"></div>

<script>

    const excludeIndices = [
        "Thể tích trung bình hồng cầu (MCV)",
        "Lượng HST trung bình hồng cầu (MCH)",
        "Nồng độ HST trung bình hồng cầu (MCHC)",
        "Thể tích khối tiểu cầu (PCT)",
        "Độ phân tán của đường kính tiểu cầu (PDW)",
        "Ưa axít + Ưa bazơ + Mono",
        "Lympho",
        "Độ phân tán của đường kính hồng cầu (RDW)",
        "Đo tiểu cầu có kích thước lớn (P_LCC)",
        "Thể tích trung bình tiểu cầu (MPV)",
        "Số lượng bạch cầu lympho",
        "Số lượng bạch cầu mono",
        "Số lượng bạch cầu GR",
        "Tỷ lệ tiểu cầu có kích thước lớn (P_LCR)"
    ];


    function showToast(message, isSuccess = true) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.backgroundColor = isSuccess ? '#27ae60' : '#e74c3c';
        toast.classList.add('show');
        
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    document.addEventListener('DOMContentLoaded', function() {

        const savedData = localStorage.getItem('cls_data');
        if (savedData) {
            const data = JSON.parse(savedData);
            document.getElementById('inputData').value = data.input || '';
            
            if (data.table && data.table.length > 0) {
                renderTable(data.table);
                document.getElementById('summary').textContent = data.summary || '';
                document.getElementById('summaryContainer').style.display = 'flex';
            }
        }
        

        const isDarkMode = localStorage.getItem('darkMode') === 'true';
        setDarkMode(isDarkMode);
        

        document.getElementById('themeToggle').addEventListener('click', toggleDarkMode);
    });


    function toggleDarkMode() {
        const isDarkMode = document.body.classList.contains('dark-mode');
        setDarkMode(!isDarkMode);
    }


    function setDarkMode(enable) {
        if (enable) {
            document.body.classList.add('dark-mode');
            document.querySelector('#themeToggle i').classList.replace('fa-moon', 'fa-sun');
            localStorage.setItem('darkMode', 'true');
        } else {
            document.body.classList.remove('dark-mode');
            document.querySelector('#themeToggle i').classList.replace('fa-sun', 'fa-moon');
            localStorage.setItem('darkMode', 'false');
        }
    }


    function processData() {
        const inputData = document.getElementById('inputData').value.trim();
        if (!inputData) {
            showToast("Vui lòng dán dữ liệu trước khi tóm tắt.", false);
            return;
        }

        const rows = inputData.split('\n');
        const tableData = [];
        let displayedIndex = 0;
        let summaryPieces = [];

        rows.forEach((row) => {
            const columns = row.split('\t');
            if (columns.length >= 6) {
                const name = columns[2].trim();
                const value = columns[5].trim();

                if (!excludeIndices.includes(name) && value !== "" && value !== "-") {
                    displayedIndex++;
                    const rowData = {
                        stt: displayedIndex,
                        code: columns[1].trim(),
                        name: name,
                        unit: columns[3].trim(),
                        average: columns[4].trim(),
                        value: value
                    };
                    tableData.push(rowData);

                    let shortName;
                    switch (name) {
                        case "Số lượng hồng cầu": shortName = "HC"; break;
                        case "Huyết sắc tố": shortName = "Hb"; break;
                        case "Hematocrit": shortName = "HTC"; break;
                        case "Số lượng tiểu cầu": shortName = "TC"; break;
                        case "Số lượng bạch cầu": shortName = "BC"; break;
                        case "Tỷ lệ bạch cầu GR": shortName = "N"; break;
                        default: shortName = name;
                    }
                    summaryPieces.push(`${shortName} ${value}`);
                }
            }
        });

        renderTable(tableData);

        const summaryText = summaryPieces.length > 0 ? summaryPieces.join(", ") : "Không tìm thấy dữ liệu để tóm tắt.";
        const summaryContainer = document.getElementById('summaryContainer');
        const summaryElem = document.getElementById('summary');
        summaryElem.textContent = summaryText;
        summaryContainer.style.display = summaryPieces.length > 0 ? "flex" : "none";

        saveToLocalStorage(inputData, tableData, summaryText);
        
        showToast("Đã xử lý dữ liệu thành công!");
    }


    function renderTable(tableData) {
        const tableBody = document.getElementById('dataTable').getElementsByTagName('tbody')[0];
        tableBody.innerHTML = '';
        
        tableData.forEach(row => {
            const newRow = tableBody.insertRow();
            newRow.insertCell(0).textContent = row.stt;
            newRow.insertCell(1).textContent = row.code;
            newRow.insertCell(2).textContent = row.name;
            newRow.insertCell(3).textContent = row.unit;
            newRow.insertCell(4).textContent = row.average;
            newRow.insertCell(5).textContent = row.value;
        });
    }

    function saveToLocalStorage(input, table, summary) {
        const data = {
            input: input,
            table: table,
            summary: summary
        };
        localStorage.setItem('cls_data', JSON.stringify(data));
    }


    function clearData() {
        document.getElementById('inputData').value = '';
        document.getElementById('dataTable').getElementsByTagName('tbody')[0].innerHTML = '';
        document.getElementById('summaryContainer').style.display = 'none';
        localStorage.removeItem('cls_data');
        showToast("Đã xóa dữ liệu");
    }


    function copySummary() {
        const summaryText = document.getElementById('summary').textContent;
        if (!summaryText || summaryText === "Không tìm thấy dữ liệu để tóm tắt.") {
            showToast("Không có dữ liệu tóm tắt để sao chép.", false);
            return;
        }

        navigator.clipboard.writeText(summaryText).then(() => {
            showToast("Đã sao chép thành công!");
        }, () => {
            showToast("Sao chép thất bại. Vui lòng thử lại.", false);
        });
    }


    function exportToExcel() {
        const table = document.getElementById('dataTable');
        if (!table.rows.length || table.rows.length < 2) {
            showToast("Không có dữ liệu để xuất Excel", false);
            return;
        }

        const html = `
            <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
            <head>
                <meta charset="UTF-8">
                <title>Bảng chỉ số CLS</title>
            </head>
            <body>
                ${table.outerHTML}
            </body>
            </html>
        `;


        const blob = new Blob([html], {type: 'application/vnd.ms-excel'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'tom_tat_cls.xls';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        showToast("Đã xuất file Excel thành công!");
    }
</script>
</body>
</html>
